---
title: "FinalRExercise_HuangZixiao.Rmd"
author: "Zixiao Huang"
date: "9/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyverse) 
library(data.table)
```

# Task 1: Import your data (nys_schools.csv and nys_acs.csv)
```{r}
# Read the data of schools
schools <- read.csv(here::here("Desktop/Northwestern/Bootcamp/bootcamp-2020/data/nys_schools.csv"))

# Read the data of counties
counties <- read.csv(here::here("Desktop/Northwestern/Bootcamp/bootcamp-2020/data/nys_acs.csv"))
```

# Task 2: Explore your data
```{r}
summary(schools)
summary(counties)
```

# Task 3: Recoding and Variable Manipulation
1. Deal with missing values, which are currently encoded as -99
```{r}
# Set all missing values to NA since later in our calculations and analysis, 
# we can just ignore them.
schools <- replace(schools, schools == -99, NA)
counties <- replace(counties, counties == -99, NA)
```

2. Create a categorical variable that groups counties into "high", "medium", and "low" poverty groups.
```{r}
# Group counties into three different poverty groups by using the median_household_income column
# Set the counties with lowest 25% median household income (first quartile) as "high" poverty group (income <= 46347)
# Set the counties with highest 25% median household income (fourth quartile) as "low" poverty group (income > 56448)
# Set the middle 50% as "medium" poverty group (46347 < income <= 56448)

# Start by creating a new variable with all missing values
counties$poverty_level <- NA
# Replace lowest 25% value with "high"
counties$poverty_level[counties$median_household_income <= 46347] <- "high"
# Replace middle 50% value with "medium"
counties$poverty_level[counties$median_household_income <= 56448 & counties$median_household_income > 46347] <- "medium"
# Replace highest 25% value with "low"
counties$poverty_level[counties$median_household_income > 56448] <- "low" 
```

3. Create a new variable that is the standardized z-score for math and English Language Arts (ELA)
for each year.
```{r}
# First group by year, then use the scale() function
schools <- schools %>%
            group_by(year) %>%
            mutate(z_score_math = scale(mean_math_score),
            z_score_ela = scale(mean_ela_score))
```

# Task 4: Merge datasets
Create a county-level dataset that merges variables from the schools dataset and the ACS dataset.
```{r}
county_school <- merge(schools, counties, by = c("county_name", "year"))
```

# Task 5: Generate summary tables
1. For each county: total enrollment, percent of students qualifying for free or reduced price lunch, and percent of 
population in poverty. 
```{r}
summary1 <- county_school %>%
              mutate(free_lunch = total_enroll * per_free_lunch, reduced_lunch = total_enroll * per_reduced_lunch) %>%
              group_by(county_name) %>%
              summarise(sum_enroll = sum(total_enroll, na.rm = T),
                  per_free_lunch = sum(total_enroll, na.rm = T) / sum(free_lunch, na.rm = T),
                  per_reduced_lunch = sum(total_enroll, na.rm = T) / sum(reduced_lunch, na.rm = T),
                  per_poverty = mean(county_per_poverty)) 

summary1
```

2. For the counties with the top 5 and bottom 5 poverty rate: percent of population in poverty, percent of students 
qualifying for free or reduced price lunch, mean reading score, and mean math score.
```{r}
# Create a temporary table with the mean reading score and mean math score for each county
tmp <- county_school %>%
        group_by(county_name) %>%
        summarise(mean_ela = mean(mean_ela_score, na.rm = T),
                  mean_math = mean(mean_math_score, na.rm = T))

# Merge the temporary table with the summary1 table in the previous task
summary2 <- merge(summary1, tmp, by = c("county_name"))

# Select the counties with the top5 and bottom5 poverty rate by removing 
summary2 <- summary2[order(-summary2$per_poverty),]
tmp <- summary2[1:5,]
tmp2 <- summary2[-1:-57,]

# Combine tmp and tmp2 together
summary2 <- rbind(tmp, tmp2)

# Select the required columns of summary2
summary2 <- summary2 %>% select(-sum_enroll)
summary2
```

# Task 6: Data Visualization
1. The relationship between access to free/reduced price lunch and test performance, at the school level.
```{r}
# Use the schools dataframe and 
```

2. Average test performance across counties with high, low, and medium poverty.

# Task 7: Answering questions
What can the data tell us about the relationship between poverty and test performance in New York public schools? Has this relationship changed over time? Is this relationship at all moderated by access to free/reduced price lunch?
