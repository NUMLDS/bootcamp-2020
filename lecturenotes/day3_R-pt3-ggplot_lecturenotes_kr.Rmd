---
title: "Intro to R: Day 1"
author: "Kumar Ramanathan"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
params:
  notes: no
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath("../"))
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r, include=FALSE}
notes<-params$notes
```

# Introduction to ggplot

## What is ggplot?

The `ggplot2` package is part of `tidyverse`, a suite of packages maintained by the RStudio company. In ggplot, graphics are built in ggplot by supplying *data* and *aesthetic mapping*, and then adding *layers* that build geometries, scales, coordinate systems, and more using the provided data and mapping.

Before using ggplot, make sure to load the package. You can either load `tidyverse` or `ggplot2` directly.

```{r}
library(tidyverse)
```

## Why ggplot?

- It is highly customizable and extensible.
- It is designed to work well in conjunction with `dplyr` and other `tidyverse` packages.
- It has been in usage for over 10 years, meaning that help is widely available.
- Its wide usage has also given rise to a wide variety of avilable [extensions](http://www.ggplot2-exts.org/gallery/), including those that handle create interactive graphics (`ggigraph`), animated graphics (`gganimate`), alluvial diagrams (`ggalluvial`), maps (`ggmap`), and more.

## Some useful resources

- The [ggplot cheatsheet](https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf) maintained by RStudio is an invaluable resource. I always have it open when using `ggplot2`.
- The [ggplot reference sheet](https://ggplot2.tidyverse.org/reference/index.html) maintained by RStudio. In your early days using `ggplot2`, this will be more useful in conjunction with the cheatsheet since it contains more detail on syntax and links to full help files. 
- The [Data Visualization chapter](http://r4ds.had.co.nz/data-visualisation.html) in the R for Data Science book by Garrett Grolemund and Hadley Wickham. The rest of the book explores other parts of the `tidyverse`.
- [ggedit](https://github.com/metrumresearchgroup/ggedit) is an extension package for `ggplot2` that enables users to launch an graphical user interface (GUI) with which to build ggplot graphics layer-by-layer. When completed, the user can copy the code required to generate the plot and return to their script file. 
    - There is [some controversy](https://www.youtube.com/watch?v=cpbtcsGE0OA) over whether GUIs diminish creativity and flexibility in data science, but nevertheless, this tool may help early learners get used to the grammar of ggplot.
- And, of course, the help files that come with the package itself.

# Basics: the grammar of graphics

ggplot works by combining several functions using the `+` operator. You can start a new line after each `+` operator for readability if you would like (I do so throughout these notes.) Each function does something specific: provide a dataset, create a geometric object, add labels, add scales, change the coordinate system or layout, change the color palette, etc. 

Each graphic generated by ggplot requires at least three basic components:

- **data**: a data frame containing the data that you want to visualize, provided in the `ggplot()` function's required `data = ` argument.
- **geometric objects**: the objects/shapes that you want to plot, indicated through one of the many available `geom` functions, such as `geom_point()` or `geom_hist()`.
- **aesthetic mapping**: the mapping from the data to the geometric objects, provided in an `aes()` function nested within the `mapping = ` argument of the `geom` function. 
    - You can also provide the `aes()` function to the `mapping = ` argument of `ggplot()`. If you do so, *all* `geom` functions will pull from the aesthetic mapping provided in this initial `ggplot()` function.

Together, the basic structure looks like this:

```{r ggplot structure, eval=F}
ggplot(data = <data frame>) + 
  geom_<type>(mapping = aes(<aesthetics info>))
```

To demonstrate with an example, let's re-create the scatterplot we made in Day 1 using data from Gapminder. Recall that we used the 2007 data subset and plotted the relationship between life expectancy on the y-axis and GDP per capita on the x-axis. Using the structure above, we would proceed as follows:

1. Provide the data in the `data = ` argument of the initial `ggplot()` function. 
2. Select `geom_point()` as our second function, since the geometric object we want to generate is points. 
3. Within the `mapping = ` argument of `geom_point()`, we provide our aesthetic mapping. In this case, we need to provide an `x` and `y` variable for the points. 

Altogether, it looks like this:

```{r scatterplot 1}
ggplot(data = gapminder07) + 
  geom_point(mapping = aes(x = gdpPercap, y = lifeExp))
```

Recall how we added a horizontal line to the scatterplot on Day 1. We can replicate that in ggplot by adding another layer using the `geom_hline()` function, which generates another geometric object (specifically, a horizontal line). Notice that `data = ` and `mapping = ` have been dropped here: as with all functions in R, since these are the first arguments, R assumes that the first inputs provided to the function are for these first arguments.

```{r scatterplot 2}
ggplot(gapminder07) + 
  geom_point(aes(x = gdpPercap, y = lifeExp)) + 
  geom_hline(aes(yintercept = mean(lifeExp)))
```

We can also add titles and axes as a layer using the `labs()` function.

```{r scatterplot 3}
ggplot(data = gapminder07) + 
  geom_point(aes(x = gdpPercap, y = lifeExp)) + 
  geom_hline(aes(yintercept = mean(lifeExp))) + 
  labs(title = "Relationship between life expectancy and GDP per capita in 2007", 
       x = "GDP per capita", y = "Life expectancy")
```

As you can see, the grammar of graphics used in ggplot2 breaks down the information that goes into each graphic into several layers, each of which you can customize.

# Preparing your data

Recall the role of pipes (`%>%`) in `dplyr` this morning. Since `dplyr` and `ggplot2` are both part of tidyverse, they are designed to work well together. You can use a series of pipes to prepare your data to be in the appropriate format, subset, etc before plotting. 

For example, consider the above plot. Instead of specifying the data in the `ggplot()` function, we can supply the data through a pipe. Instead of using the subsetted `gapminder07` data, we can use the original `gapminder5` and use a `filter()` function to select the 2007 observations only.

```{r piping and filtering}
gapminder5 %>% 
  filter(year == 2007) %>% 
  ggplot() + 
  geom_point(aes(x = gdpPercap, y = lifeExp)) + 
  geom_hline(aes(yintercept = mean(lifeExp))) + 
  labs(title = "Relationship between life expectancy and GDP per capita in 2007", 
       x = "GDP per capita", y = "Life expectancy")
```

The above example is a straightforward one to motivate the principle that data may need to be manipulated before being supplied to a `ggplot()` function. Oftentimes, preparation involves more complicated data manipulation, and involves recoding, summarising, converting to long format, etc. In the next few sections, we will see several examples of this.

# Aesthetics

## Colors

## Shapes and sizes

# Geometries

## Common geometries

## Multiple geometries in one plot

# Additional layers

## Stats

## Scales

## Labels

## Themes

## Legends

## Coordinate system adjustment

# Grouped data

## Using colors

## Position adjustment

## Facets

Let's say we are interested in examining hour-by-hour generation data by source. Using the position adjustment skills we learned in the previous subsection, we can generate a line plot as follows.

```{r why facet}
long_merged_energy %>% 
  filter(source!="imports") %>%
  ggplot() + 
  geom_line(aes(x=datetime, y=output, group=source, col=source, position="dodge"), size=1) + 
  labs(title="Generation over time, by energy source", x="Hour", y="Output")
```

```{r facet 1}
long_merged_energy %>% 
  filter(source!="imports") %>%
  ggplot() + 
  geom_line(aes(x = datetime, y = output)) + 
  facet_wrap(.~source)
```

```{r facet 2}
long_merged_energy %>% 
  filter(source!="imports") %>%
  ggplot() + 
  geom_line(aes(x = datetime, y = output)) + 
  facet_wrap(.~source, scales="free") + 
  labs(title = "Generation over time, Sep 3-9", x = "Hour", y = "Output")
```

```{r facet 3}
regroup %>% 
  rename(source = type) %>%
  merge(long_merged_energy, by = "source") %>% 
  filter(source!="imports") %>%
  ggplot() + 
  geom_line(aes(x = datetime, y = output, col=group)) + 
  facet_wrap(.~source, scales="free") + 
  labs(title = "Generation over time, Sep 3-9", x = "Hour", y = "Output") + 
  theme_minimal() + 
  theme(legend.position = "bottom")
```

# Final notes

## Comment your code

## Saving images

# Data visualization beyond ggplot2